language: cpp

matrix:
  include:
    - os: linux
      dist: bionic
      compiler: gcc
      env:
        - CROSSCOMPILE=x86_64-w64-mingw32
        - RELEASE=win64
        - CXX_COMPILER=x86_64-w64-mingw32-g++
        - CC_COMPILER=x86_64-w64-mingw32-gcc
        addons:
        apt:
          packages:
            - mingw-w64
            - binutils-mingw-w64-x86-64
            - gcc-mingw-w64-x86-64
            - g++-mingw-w64-x86-64
            - mingw-w64-x86-64-dev
            - cmake
    - os: linux
      dist: bionic
      compiler: gcc
      env:
        - CROSSCOMPILE=i686-w64-mingw32
        - RELEASE=win32
        - CXX_COMPILER=i686-w64-mingw32-g++
        - CC_COMPILER=i686-w64-mingw32-gcc
        addons:
        apt:
          packages:
            - mingw-w64
            - binutils-mingw-w64-i686
            - gcc-mingw-w64-i686
            - g++-mingw-w64-i686
            - mingw-w64-i686-dev
            - cmake
    - os: osx
      osx_image: xcode11
      compiler: gcc
      env:
        - CROSSCOMPILE=native
        - CXX_COMPILER=g++-9
        - CC_COMPILER=gcc-9
        - RELEASE=macos

branches:
  only:
  - master

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update               ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew upgrade cmake        ; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install gcc@9 | true ; fi
  - ./autogen.sh

script:
  - if [[ "$CROSSCOMPILE" == "native" ]]; then mkdir build && cd build && cmake .. -DCMAKE_C_COMPILER=${CC_COMPILER} -DCMAKE_CXX_COMPILER=${CXX_COMPILER} && make && cd .. ; fi
  - if [[ "$CROSSCOMPILE" == "x86_64-w64-mingw32" || "$CROSSCOMPILE" == "i686-w64-mingw32" ]]; then mkdir build && cd build && cmake .. -G"MinGW Makefiles" && make && cd .. ; fi

after_success:
  - if [[ "$TRAVIS_PULL_REQUEST" == "false" ]]; then GITHUB_TOKEN=${GITHUB_TOKEN} TRAVIS_BRANCH=${TRAVIS_BRANCH} TRAVIS_JOB_NUMBER=${TRAVIS_JOB_NUMBER} encrypted_61dd9981ab75_key=${encrypted_61dd9981ab75_key} ./deploy.sh $RELEASE push ; fi
